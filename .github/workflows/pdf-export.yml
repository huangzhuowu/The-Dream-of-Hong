name: Build and Publish PDF

on:
  push:
    branches:
      - main
      - master
    paths:
      - '_history/**'
      - '_entertainment/**'
      - '_metaphysics/**'
      - 'scripts/**'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æŠŠ PDF æ¨é€å›ä»“åº“

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: |
          pip install pyyaml
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended fonts-noto-cjk

      - name: Run Python Script (Split Mode)
        run: python scripts/generate_pdf_source.py

      - name: Convert to PDF
        run: |
          # ä½¿ç”¨åˆ†ç¦»æ¨¡å¼ï¼šåŒæ—¶è¾“å…¥ metadata.yaml å’Œ content.md
          pandoc metadata.yaml content.md -o HongQing_Archives.pdf \
            --pdf-engine=xelatex \
            --standalone \
            -V CJKmainfont="Noto Sans CJK SC" \
            --verbose

      - name: Commit PDF to Repo
        run: |
          # 1. æ£€æŸ¥ PDF æ˜¯å¦ç”Ÿæˆ
          if [ -f "HongQing_Archives.pdf" ]; then
            echo "âœ… PDF æˆåŠŸç”Ÿæˆ"
          else
            echo "âŒ é”™è¯¯ï¼šPDF æ–‡ä»¶æœªæ‰¾åˆ°ï¼"
            exit 1
          fi

          # 2. å‡†å¤‡æ–‡ä»¶å¤¹
          mkdir -p assets/downloads
          mv -f HongQing_Archives.pdf assets/downloads/HongQing_Archives.pdf
          
          # 3. é…ç½®èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 4. æäº¤å¹¶æ¨é€
          git add assets/downloads/HongQing_Archives.pdf
          
          if git diff --staged --quiet; then
            echo "âš ï¸ PDF å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "Auto-update PDF export [skip ci]"
            git push
            echo "ğŸš€ PDF å·²æˆåŠŸæ¨é€åˆ°ä»“åº“ï¼"
          fi
